<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shareholders of MTL and affiliates</title>
    <script src="./bower_components/stellar-sdk/stellar-sdk.js"></script>
    <script>
      const MTL_CODE = 'MTL';
      const MTL_ISSUER =
        'GACKTN5DAZGWXRWB2WLM6OPBDHAMT6SJNGLJZPQMEZBUR4JUGBX2UK7V';
      const MTL_TREASURY =
        'GDX23CPGMQ4LN55VGEDVFZPAJMAUEHSHAMJ2GMCU2ZSHN5QF4TMZYPIS';
      const MTL =
        new StellarSdk.Asset(MTL_CODE, MTL_ISSUER);
      const server = new StellarSdk.Server('https://horizon.stellar.org');
    </script>
  </head>
  <body>
    <h2>MTL Shareholders</h2>
    <p>MTL supply: <span id="mtl_supply_text">0</span></p>
    <p>MTL distributed: <span id="mtl_distributed_text">0</span></p>
    <table id="mtl_holders_table"><th>Tokens</th><th>Account</th></table>

    <script>
      function collectPages(onPage, atEnd) {
        function recur(collectionPage) {
          if (collectionPage.records.length) {
            onPage(collectionPage);
            collectionPage.next().then(recur);
          } else {
            // end of collection
            atEnd();
          }
        };
        return recur;
      }

      let mtl_holders = [];
      let mtl_supply = 0;
      let mtl_distributed = 0;
      function appendMtlHolders(collectionPage) {
        mtl_holders = mtl_holders.concat(collectionPage.records);
        for (const accountRecord of collectionPage.records) {
          const [balance] =
            accountRecord
            .balances
            .filter(
              ({asset_code, asset_issuer}) =>
                asset_code == MTL_CODE && asset_issuer == MTL_ISSUER
            )
            .map(({balance}) => +balance);
          accountRecord.mtl_balance = balance;

          mtl_supply += balance;
          mtl_supply_text.innerText = mtl_supply;

          if (accountRecord.account_id != MTL_TREASURY)
            mtl_distributed += balance;
          mtl_distributed_text.innerText = mtl_distributed;
        }
      }

      function appendMtlHoldersTableRow(accountRecord) {
        const name =
          accountRecord.account_id == MTL_TREASURY
          ? 'MTL Treasury'
          : 'â€¦' + accountRecord.account_id.substring(52);

        const tr =
          mtl_holders_table.appendChild(document.createElement('tr'));
        tr.classList.add('item');
        tr.appendChild(document.createElement('td'))
          .appendChild(document.createTextNode(accountRecord.mtl_balance));
        tr.appendChild(document.createElement('td'))
          .appendChild(document.createTextNode(name));
      }

      function finishMtlHoldersTable() {
        // sort by .mtl_balance descending
        mtl_holders.sort((a, b) => b.mtl_balance - a.mtl_balance);
        mtl_holders.forEach(appendMtlHoldersTableRow);
      }

      server
        .accounts()
        .forAsset(MTL)
        .call()
        .then(collectPages(appendMtlHolders, finishMtlHoldersTable));
    </script>

  </body>
</html>
